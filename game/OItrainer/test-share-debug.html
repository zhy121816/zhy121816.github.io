<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ†äº«åŠŸèƒ½è°ƒè¯• - zhanghy16çš„ä¸»é¡µ</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 { color: #333; margin-top: 0; }
    h3 { color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 8px; }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 4px;
    }
    button:hover { background: #0056b3; }
    button.success { background: #28a745; }
    button.success:hover { background: #218838; }
    pre {
      background: #f1f3f5;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .status {
      padding: 12px;
      border-radius: 6px;
      margin: 12px 0;
      font-size: 14px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }
    .status.warning {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffc107;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” åˆ†äº«åŠŸèƒ½è°ƒè¯•å·¥å…·</h1>
    
    <div class="status warning">
      <strong>è°ƒè¯•ç›®æ ‡ï¼š</strong>æ£€æŸ¥ ShareManager æ˜¯å¦æ­£ç¡®åœ°å°† devToolsDetection æ•°æ®ç¼–ç åˆ°åˆ†äº«é“¾æ¥ä¸­
    </div>
  </div>

  <div class="container">
    <h3>æ­¥éª¤ 1ï¼šåˆ›å»ºæµ‹è¯•å­˜æ¡£</h3>
    <button onclick="createTestSave()">åˆ›å»ºæµ‹è¯•å­˜æ¡£ï¼ˆåŒ…å«æ£€æµ‹æ•°æ®ï¼‰</button>
    <div id="save-result"></div>
  </div>

  <div class="container">
    <h3>æ­¥éª¤ 2ï¼šç”Ÿæˆåˆ†äº«é“¾æ¥</h3>
    <button onclick="generateShare()">ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
    <div id="share-result"></div>
  </div>

  <div class="container">
    <h3>æ­¥éª¤ 3ï¼šè§£æåˆ†äº«é“¾æ¥</h3>
    <button onclick="parseShare()">è§£æå¹¶éªŒè¯æ•°æ®</button>
    <div id="parse-result"></div>
  </div>

  <div class="container">
    <h3>æ­¥éª¤ 4ï¼šæµ‹è¯• shared.html æ¸²æŸ“</h3>
    <button onclick="testSharedRender()">æ¨¡æ‹Ÿ shared.html æ¸²æŸ“</button>
    <button class="success" id="goto-shared" disabled>è·³è½¬åˆ° shared.html</button>
    <div id="render-result"></div>
  </div>

  <script src="lib/constants.js"></script>
  <script src="lib/utils.js"></script>
  <script src="lib/models.js"></script>
  <script src="lib/talent.js"></script>
  <script src="lib/share.js"></script>
  <script src="game.js"></script>
  
  <script>
    let generatedShareUrl = null;

    function log(containerId, html, type = 'success') {
      const container = document.getElementById(containerId);
      if (container) {
        container.innerHTML = `<div class="status ${type}">${html}</div>`;
      }
    }

    function createTestSave() {
      try {
        console.log('[Debug] åˆ›å»ºæµ‹è¯•å­˜æ¡£...');
        
        const testSave = {
          week: 14,
          budget: 80000,
          reputation: 70,
          totalExpenses: 120000,
          initial_students: 8,
          difficulty: 2,
          endingReason: 'èµ›å­£ç»“æŸ',
          students: [
            { 
              name: 'æµ‹è¯•å­¦ç”Ÿ1', 
              ability: 75, 
              active: true, 
              pressure: 45, 
              thinking: 80, 
              coding: 75, 
              mental: 70,
              knowledge_ds: 80,
              knowledge_graph: 70,
              knowledge_string: 60,
              knowledge_math: 75,
              knowledge_dp: 65,
              talents: []
            }
          ],
          facilities: { pc: 2, ac: 2, dorm: 1, canteen: 1 },
          careerCompetitions: [],
          // å…³é”®ï¼šæ·»åŠ æ£€æµ‹æ•°æ®
          devToolsDetection: {
            detected: true,
            detectedBackup1: true,
            detectedBackup2: true,
            firstDetectedTime: Date.now() - 600000,
            firstDetectedTimeBackup: Date.now() - 600000,
            detectionCount: 8,
            detectionCountBackup: 8,
            checksum: 'test_checksum_123',
            checksumBackup: 'test_checksum_123',
            lastUpdateTime: Date.now(),
            lastUpdateTimeBackup: Date.now()
          }
        };

        const saveStr = JSON.stringify(testSave);
        localStorage.setItem('oi_coach_save', saveStr);
        
        console.log('[Debug] å­˜æ¡£å·²ä¿å­˜');
        console.log('[Debug] devToolsDetection:', testSave.devToolsDetection);
        
        log('save-result', `
          <strong>âœ“ æµ‹è¯•å­˜æ¡£åˆ›å»ºæˆåŠŸ</strong><br><br>
          å­˜æ¡£å¤§å°: ${saveStr.length} å­—èŠ‚<br>
          devToolsDetection.detected: <span style="color:#dc3545;font-weight:bold">true</span><br>
          detectionCount: <strong>8</strong><br><br>
          <details>
            <summary>æŸ¥çœ‹å®Œæ•´ devToolsDetection</summary>
            <pre>${JSON.stringify(testSave.devToolsDetection, null, 2)}</pre>
          </details>
        `, 'success');
      } catch (e) {
        console.error('[Debug] åˆ›å»ºå­˜æ¡£å¤±è´¥:', e);
        log('save-result', `<strong>âœ— å¤±è´¥:</strong> ${e.message}`, 'error');
      }
    }

    function generateShare() {
      try {
        console.log('[Debug] å¼€å§‹ç”Ÿæˆåˆ†äº«é“¾æ¥...');
        
        const saveStr = localStorage.getItem('oi_coach_save');
        if (!saveStr) {
          log('share-result', '<strong>âœ— æ— å­˜æ¡£æ•°æ®</strong>ï¼Œè¯·å…ˆåˆ›å»ºæµ‹è¯•å­˜æ¡£', 'error');
          return;
        }

        const saveData = JSON.parse(saveStr);
        console.log('[Debug] å­˜æ¡£æ•°æ®åŠ è½½å®Œæˆ');
        console.log('[Debug] saveData.devToolsDetection:', saveData.devToolsDetection);
        
        // è®¾ç½® window.game
        window.game = saveData;
        
        if (typeof ShareManager === 'undefined') {
          log('share-result', '<strong>âœ— ShareManager æœªåŠ è½½</strong>', 'error');
          return;
        }

        console.log('[Debug] è°ƒç”¨ ShareManager.generateShareLink()...');
        const shareUrl = ShareManager.generateShareLink();
        
        if (!shareUrl) {
          log('share-result', '<strong>âœ— ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥</strong>', 'error');
          return;
        }

        generatedShareUrl = shareUrl;
        console.log('[Debug] åˆ†äº«é“¾æ¥ç”ŸæˆæˆåŠŸ');
        console.log('[Debug] URL:', shareUrl);
        
        log('share-result', `
          <strong>âœ“ åˆ†äº«é“¾æ¥ç”ŸæˆæˆåŠŸ</strong><br><br>
          <textarea readonly style="width:100%;height:100px;font-size:11px;font-family:monospace">${shareUrl}</textarea><br><br>
          <button onclick="copyUrl()">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
        `, 'success');
      } catch (e) {
        console.error('[Debug] ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥:', e);
        log('share-result', `<strong>âœ— å¤±è´¥:</strong> ${e.message}<br><pre>${e.stack}</pre>`, 'error');
      }
    }

    function copyUrl() {
      if (generatedShareUrl) {
        navigator.clipboard.writeText(generatedShareUrl).then(() => {
          alert('é“¾æ¥å·²å¤åˆ¶ï¼');
        }).catch(() => {
          prompt('è¯·æ‰‹åŠ¨å¤åˆ¶:', generatedShareUrl);
        });
      }
    }

    function parseShare() {
      try {
        if (!generatedShareUrl) {
          log('parse-result', '<strong>âš ï¸ è¯·å…ˆç”Ÿæˆåˆ†äº«é“¾æ¥</strong>', 'warning');
          return;
        }

        console.log('[Debug] å¼€å§‹è§£æåˆ†äº«é“¾æ¥...');
        const sharedData = ShareManager.parseSharedData(generatedShareUrl);
        
        if (!sharedData) {
          log('parse-result', '<strong>âœ— è§£æå¤±è´¥</strong>', 'error');
          return;
        }

        console.log('[Debug] åˆ†äº«æ•°æ®è§£ææˆåŠŸ');
        console.log('[Debug] sharedData:', sharedData);
        console.log('[Debug] sharedData.gameState:', sharedData.gameState);
        console.log('[Debug] sharedData.gameState.devTools:', sharedData.gameState.devTools);

        const devTools = sharedData.gameState.devTools;
        
        let html = '<strong>âœ“ åˆ†äº«æ•°æ®è§£ææˆåŠŸ</strong><br><br>';
        
        if (devTools) {
          html += `<strong style="color:#28a745">âœ“ åŒ…å« devTools å­—æ®µ</strong><br><br>`;
          html += `detected: <span style="color:${devTools.detected ? '#dc3545' : '#28a745'};font-weight:bold">${devTools.detected}</span><br>`;
          html += `tampered: ${devTools.tampered}<br>`;
          html += `detectionCount: ${devTools.detectionCount || 0}<br>`;
          html += `trustLevel: ${devTools.trustLevel}%<br>`;
          html += `message: ${devTools.message || 'æ— '}<br><br>`;
          html += `<details><summary>å®Œæ•´ devTools æ•°æ®</summary><pre>${JSON.stringify(devTools, null, 2)}</pre></details>`;
          
          // å¯ç”¨è·³è½¬æŒ‰é’®
          document.getElementById('goto-shared').disabled = false;
          document.getElementById('goto-shared').onclick = () => {
            window.location.href = generatedShareUrl;
          };
        } else {
          html += `<strong style="color:#dc3545">âœ— ç¼ºå°‘ devTools å­—æ®µï¼</strong><br><br>`;
          html += `è¿™æ˜¯é—®é¢˜çš„æ ¹æºã€‚ShareManager æ²¡æœ‰æ­£ç¡®ç¼–ç  devToolsDetection æ•°æ®ã€‚`;
        }
        
        html += `<br><br><details><summary>å®Œæ•´ gameState æ•°æ®</summary><pre>${JSON.stringify(sharedData.gameState, null, 2)}</pre></details>`;
        
        log('parse-result', html, devTools ? 'success' : 'error');
      } catch (e) {
        console.error('[Debug] è§£æå¤±è´¥:', e);
        log('parse-result', `<strong>âœ— è§£æå¤±è´¥:</strong> ${e.message}<br><pre>${e.stack}</pre>`, 'error');
      }
    }

    function testSharedRender() {
      try {
        if (!generatedShareUrl) {
          log('render-result', '<strong>âš ï¸ è¯·å…ˆç”Ÿæˆåˆ†äº«é“¾æ¥</strong>', 'warning');
          return;
        }

        console.log('[Debug] æµ‹è¯• shared.html æ¸²æŸ“é€»è¾‘...');
        
        const sharedData = ShareManager.parseSharedData(generatedShareUrl);
        if (!sharedData || !sharedData.gameState) {
          log('render-result', '<strong>âœ— æ— æ³•è§£æåˆ†äº«æ•°æ®</strong>', 'error');
          return;
        }

        const o = sharedData.gameState;
        console.log('[Debug] o.devTools:', o.devTools);
        
        // æ¨¡æ‹Ÿ shared.html çš„æ¸²æŸ“é€»è¾‘
        let devToolsHtml = '';
        try {
          const devToolsResult = o.devTools || null;
          console.log('[Debug] devToolsResult:', devToolsResult);
          
          if (devToolsResult && (devToolsResult.detected || devToolsResult.tampered)) {
            console.log('[Debug] åº”è¯¥æ˜¾ç¤ºè­¦å‘Š');
            const bgColor = devToolsResult.tampered ? '#f8d7da' : '#fff3cd';
            const textColor = devToolsResult.tampered ? '#721c24' : '#856404';
            const borderColor = devToolsResult.tampered ? '#dc3545' : '#ffc107';
            const icon = devToolsResult.tampered ? 'â›”' : 'âš ï¸';
            const title = devToolsResult.tampered ? 'å­˜æ¡£æ•°æ®å¼‚å¸¸' : 'å­˜æ¡£å®Œæ•´æ€§æç¤º';
            const trustText = devToolsResult.tampered ? '(æ•°æ®å¼‚å¸¸)' : `(å¯ä¿¡åº¦: ${devToolsResult.trustLevel}%)`;
            
            devToolsHtml = `
              <div style="background:${bgColor};color:${textColor};padding:12px;border-radius:8px;margin:16px 0;border:1px solid ${borderColor}">
                <div style="display:flex;align-items:center;justify-content:space-between">
                  <div style="font-weight:bold;font-size:14px">${icon} ${title}</div>
                  <div style="font-size:12px;opacity:0.8">${trustText}</div>
                </div>
                <div style="font-size:13px;margin-top:6px">${devToolsResult.message || ''}</div>
                ${devToolsResult.detected && devToolsResult.detectionCount > 0 ? `<div style="font-size:12px;margin-top:4px;opacity:0.9">æ£€æµ‹æ¬¡æ•°: ${devToolsResult.detectionCount}</div>` : ''}
              </div>
            `;
          } else {
            console.log('[Debug] ä¸æ˜¾ç¤ºè­¦å‘Šï¼ˆæœªæ£€æµ‹åˆ°æˆ–æ— æ•°æ®ï¼‰');
          }
        } catch (e) {
          console.error('[Debug] è·å–å¼€å‘è€…å·¥å…·æ£€æµ‹ç»“æœå¤±è´¥:', e);
        }
        
        let html = '<strong>shared.html æ¸²æŸ“æµ‹è¯•ç»“æœï¼š</strong><br><br>';
        
        if (devToolsHtml) {
          html += '<strong style="color:#28a745">âœ“ è­¦å‘Šæ¡†åº”è¯¥æ˜¾ç¤ºï¼š</strong><br>' + devToolsHtml;
        } else {
          html += '<strong style="color:#ffc107">âš ï¸ ä¸ä¼šæ˜¾ç¤ºè­¦å‘Šæ¡†</strong><br><br>';
          if (!o.devTools) {
            html += 'åŸå› ï¼š<strong>o.devTools ä¸º null æˆ– undefined</strong><br>';
            html += 'è¿™æ„å‘³ç€ ShareManager æ²¡æœ‰æ­£ç¡®åœ°å°† devToolsDetection ç¼–ç åˆ°åˆ†äº«æ•°æ®ä¸­ã€‚';
          } else if (!o.devTools.detected && !o.devTools.tampered) {
            html += 'åŸå› ï¼šdevTools.detected = false ä¸” devTools.tampered = false';
          }
        }
        
        log('render-result', html, devToolsHtml ? 'success' : 'warning');
      } catch (e) {
        console.error('[Debug] æµ‹è¯•å¤±è´¥:', e);
        log('render-result', `<strong>âœ— æµ‹è¯•å¤±è´¥:</strong> ${e.message}<br><pre>${e.stack}</pre>`, 'error');
      }
    }

    // é¡µé¢åŠ è½½æ—¶çš„æç¤º
    window.addEventListener('load', () => {
      console.log('[Debug] è°ƒè¯•é¡µé¢å·²åŠ è½½');
      console.log('[Debug] ShareManager å¯ç”¨:', typeof ShareManager !== 'undefined');
    });
  </script>
</body>
</html>
